# ROIMSG 환경설정 가이드

## 목차
1. [로컬 개발 환경설정](#1-로컬-개발-환경설정)
2. [테스트 서버 환경설정](#2-테스트-서버-환경설정)
3. [운영 서버 환경설정](#3-운영-서버-환경설정)
4. [환경별 설정 비교표](#4-환경별-설정-비교표)

---

## 1. 로컬 개발 환경설정

### 1.1. 필수 프로그램 설치

#### 1.1.1. Node.js (v18.0.0 이상)

**Windows 설치:**
```powershell
# Chocolatey를 사용한 설치
choco install nodejs-lts

# 또는 공식 사이트에서 다운로드
# https://nodejs.org/
```

**설치 확인:**
```bash
node --version  # v18.0.0 이상
npm --version   # v9.0.0 이상
```

#### 1.1.2. Java Development Kit (JDK 21)

**Windows 설치:**
```powershell
# Chocolatey를 사용한 설치
choco install openjdk21

# 또는 공식 사이트에서 다운로드
# https://www.oracle.com/java/technologies/downloads/#java21
```

**환경변수 설정:**
```powershell
# JAVA_HOME 설정
setx JAVA_HOME "C:\Program Files\Java\jdk-21"
setx PATH "%PATH%;%JAVA_HOME%\bin"
```

**설치 확인:**
```bash
java --version  # openjdk 21 이상
javac --version # javac 21 이상
```

#### 1.1.3. Apache Maven (v3.9.0 이상)

**Windows 설치:**
```powershell
# Chocolatey를 사용한 설치
choco install maven

# 또는 공식 사이트에서 다운로드
# https://maven.apache.org/download.cgi
```

**설치 확인:**
```bash
mvn --version
```

#### 1.1.4. PostgreSQL (v15 이상)

**Windows 설치:**
```powershell
# Chocolatey를 사용한 설치
choco install postgresql

# 또는 공식 사이트에서 다운로드
# https://www.postgresql.org/download/windows/
```

**데이터베이스 설정:**
```sql
-- PostgreSQL에 관리자 계정으로 접속
psql -U postgres

-- 사용자 생성
CREATE USER roit WITH PASSWORD 'fhdlxpzm1*';

-- 데이터베이스 생성
CREATE DATABASE ROIMSG OWNER roit;

-- 권한 부여
GRANT ALL PRIVILEGES ON DATABASE ROIMSG TO roit;

-- 연결 확인
\c ROIMSG
\dt
```

#### 1.1.5. Redis (v7.0 이상)

**Windows 설치:**
```powershell
# Chocolatey를 사용한 설치
choco install redis-64

# Redis 서비스 시작
redis-server
```

**설치 확인:**
```bash
redis-cli ping
# 응답: PONG
```

#### 1.1.6. Git

**Windows 설치:**
```powershell
# Chocolatey를 사용한 설치
choco install git

# 또는 공식 사이트에서 다운로드
# https://git-scm.com/download/win
```

**설치 확인:**
```bash
git --version
```

### 1.2. 프로젝트 클론 및 초기 설정

```bash
# 저장소 클론
git clone https://github.com/lovably74/ROIMSG.git
cd ROIMSG

# 프론트엔드 의존성 설치
cd frontend/web-app
npm install

# 백엔드 의존성 확인 (Maven이 자동으로 처리)
cd ../../backend
```

### 1.3. 환경변수 설정

#### 1.3.1. 루트 디렉토리 `.env` 파일

프로젝트 루트에 `.env` 파일을 생성합니다:

```env
# ===========================================
# 데이터베이스 설정
# ===========================================
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ROIMSG
DB_USER=roit
DB_PASSWORD=fhdlxpzm1*

# ===========================================
# Google OAuth 2.0 설정 (개발 환경)
# ===========================================
GOOGLE_CLIENT_ID=386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/callback

# ===========================================
# JWT 설정
# ===========================================
JWT_SECRET=your_super_secret_jwt_key_here_change_this_in_production_at_least_32_characters_long
JWT_EXPIRATION=86400
JWT_REFRESH_EXPIRATION=604800
JWT_SIGNUP_EXPIRATION=600

# ===========================================
# Redis 설정
# ===========================================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DATABASE=0

# ===========================================
# 서버 설정
# ===========================================
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# API Gateway 설정
API_GATEWAY_PORT=8080
API_GATEWAY_HOST=0.0.0.0

# ===========================================
# 파일 업로드 설정
# ===========================================
MAX_FILE_SIZE=10485760
UPLOAD_PATH=./uploads
ALLOWED_FILE_TYPES=jpg,jpeg,png,gif,pdf,doc,docx,xls,xlsx,ppt,pptx,txt

# ===========================================
# 멀티테넌시 설정
# ===========================================
DEFAULT_TENANT_ID=550e8400-e29b-41d4-a716-446655440000
TENANT_HEADER=X-Tenant-Id

# ===========================================
# WebSocket 설정
# ===========================================
WS_PORT=3001
WS_HOST=0.0.0.0

# ===========================================
# 로깅 설정
# ===========================================
LOG_LEVEL=debug
LOG_FORMAT=json
LOG_FILE=./logs/roimsg.log

# ===========================================
# 보안 설정
# ===========================================
CORS_ORIGIN=http://localhost:3000
CORS_CREDENTIALS=true
ENCRYPTION_KEY=your_32_character_encryption_key_here
SESSION_SECRET=your_session_secret_here_change_this_in_production

# ===========================================
# 다국어 설정
# ===========================================
DEFAULT_LANGUAGE=ko
SUPPORTED_LANGUAGES=ko,en
TIMEZONE=Asia/Seoul
```

#### 1.3.2. 프론트엔드 환경변수 (frontend/web-app/.env.local)

**참고:** `.env.local` 파일은 `.gitignore`에 포함되어 있어 Git에서 추적되지 않습니다.

```bash
# frontend/web-app 디렉토리로 이동
cd frontend/web-app

# PowerShell에서 환경변수 설정 후 실행
$env:VITE_API_BASE_URL="http://localhost:8080"
$env:VITE_GOOGLE_CLIENT_ID="386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com"
$env:VITE_GOOGLE_REDIRECT_URI="http://localhost:3000/auth/callback"
$env:VITE_GOOGLE_AUTH_URI="https://accounts.google.com/o/oauth2/v2/auth"
$env:VITE_WS_URL="ws://localhost:3001"
$env:VITE_DEFAULT_TENANT_ID="550e8400-e29b-41d4-a716-446655440000"

npm run dev
```

### 1.4. 데이터베이스 초기화

```bash
# 프로젝트 루트에서 실행
cd scripts
npm install

# 데이터베이스 스키마 생성
node setup-database.js

# 또는 SQL 파일 직접 실행
psql -U roit -d ROIMSG -f sql/01-create-tables.sql
psql -U roit -d ROIMSG -f sql/02-create-indexes.sql
psql -U roit -d ROIMSG -f sql/03-insert-sample-data.sql
```

### 1.5. Google OAuth 설정

1. [Google Cloud Console](https://console.cloud.google.com/) 접속
2. 새 프로젝트 생성 또는 기존 프로젝트 선택
3. **API 및 서비스 > OAuth 동의 화면** 설정
   - 사용자 유형: 외부
   - 앱 이름: ROIMSG
   - 지원 이메일: your-email@example.com
4. **API 및 서비스 > 사용자 인증 정보** 설정
   - OAuth 2.0 클라이언트 ID 만들기
   - 애플리케이션 유형: 웹 애플리케이션
   - 승인된 리디렉션 URI: `http://localhost:3000/auth/callback`
5. 클라이언트 ID와 클라이언트 보안 비밀번호를 `.env` 파일에 추가

**개발 환경 전용 계정 정보:**
- Client ID: `386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com`
- Client Secret: `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`

---

## 2. 테스트 서버 환경설정

### 2.1. 시스템 요구사항

- **OS:** Ubuntu 22.04 LTS
- **CPU:** 4 Core 이상
- **RAM:** 8GB 이상
- **Disk:** 100GB 이상
- **Network:** 공인 IP 또는 도메인

### 2.2. Docker 및 Docker Compose 설치

```bash
# Docker 설치
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Docker Compose 설치
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 설치 확인
docker --version
docker-compose --version
```

### 2.3. 환경변수 설정

테스트 서버용 `.env` 파일:

```env
# ===========================================
# 데이터베이스 설정
# ===========================================
DB_HOST=postgres
DB_PORT=5432
DB_NAME=ROIMSG_TEST
DB_USER=roit_test
DB_PASSWORD=test_secure_password_here

# ===========================================
# Google OAuth 2.0 설정 (테스트 환경)
# ===========================================
GOOGLE_CLIENT_ID=your_test_google_client_id
GOOGLE_CLIENT_SECRET=your_test_google_client_secret
GOOGLE_REDIRECT_URI=https://test.roimsg.com/auth/callback

# ===========================================
# JWT 설정
# ===========================================
JWT_SECRET=test_jwt_secret_key_at_least_32_characters_long_secure
JWT_EXPIRATION=86400
JWT_REFRESH_EXPIRATION=604800

# ===========================================
# Redis 설정
# ===========================================
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=test_redis_password

# ===========================================
# 서버 설정
# ===========================================
NODE_ENV=test
API_GATEWAY_PORT=8080

# ===========================================
# 로깅 설정
# ===========================================
LOG_LEVEL=info
LOG_FORMAT=json

# ===========================================
# 보안 설정
# ===========================================
CORS_ORIGIN=https://test.roimsg.com
ENCRYPTION_KEY=test_32_character_encryption_key
```

### 2.4. Docker Compose 설정

`infrastructure/test/docker-compose.yml` 파일 사용:

```bash
cd infrastructure/test

# 서비스 시작
docker-compose up -d

# 로그 확인
docker-compose logs -f

# 서비스 상태 확인
docker-compose ps
```

### 2.5. Nginx 리버스 프록시 설정

```nginx
# /etc/nginx/sites-available/roimsg-test
server {
    listen 80;
    server_name test.roimsg.com;

    # HTTPS로 리다이렉트
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name test.roimsg.com;

    ssl_certificate /etc/letsencrypt/live/test.roimsg.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/test.roimsg.com/privkey.pem;

    # API Gateway
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket
    location /ws/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2.6. SSL 인증서 설정 (Let's Encrypt)

```bash
# Certbot 설치
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# SSL 인증서 발급
sudo certbot --nginx -d test.roimsg.com

# 자동 갱신 설정
sudo certbot renew --dry-run
```

---

## 3. 운영 서버 환경설정

### 3.1. 시스템 요구사항

- **OS:** Ubuntu 22.04 LTS
- **CPU:** 8 Core 이상
- **RAM:** 16GB 이상
- **Disk:** 500GB SSD
- **Network:** 공인 IP, 도메인, CDN

### 3.2. Kubernetes 클러스터 설정

#### 3.2.1. Kubernetes 설치

```bash
# kubeadm, kubelet, kubectl 설치
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl

curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

#### 3.2.2. 클러스터 초기화

```bash
# 마스터 노드 초기화
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# kubectl 설정
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 네트워크 플러그인 설치 (Flannel)
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

### 3.3. 환경변수 설정 (ConfigMap & Secret)

#### 3.3.1. ConfigMap 생성

```yaml
# infrastructure/prod/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: roimsg-config
  namespace: roimsg
data:
  DB_HOST: "postgres-service"
  DB_PORT: "5432"
  DB_NAME: "ROIMSG_PROD"
  REDIS_HOST: "redis-service"
  REDIS_PORT: "6379"
  NODE_ENV: "production"
  API_GATEWAY_PORT: "8080"
  LOG_LEVEL: "warn"
  CORS_ORIGIN: "https://roimsg.com"
  DEFAULT_TENANT_ID: "550e8400-e29b-41d4-a716-446655440000"
  GOOGLE_REDIRECT_URI: "https://roimsg.com/auth/callback"
```

#### 3.3.2. Secret 생성

```bash
# Kubernetes Secret 생성
kubectl create secret generic roimsg-secrets \
  --from-literal=DB_USER=roit_prod \
  --from-literal=DB_PASSWORD=prod_secure_password_here \
  --from-literal=GOOGLE_CLIENT_ID=your_prod_google_client_id \
  --from-literal=GOOGLE_CLIENT_SECRET=your_prod_google_client_secret \
  --from-literal=JWT_SECRET=prod_jwt_secret_key_at_least_32_characters_long \
  --from-literal=REDIS_PASSWORD=prod_redis_password \
  --from-literal=ENCRYPTION_KEY=prod_32_character_encryption_key \
  -n roimsg
```

### 3.4. 데이터베이스 설정

#### 3.4.1. PostgreSQL (운영 환경)

```yaml
# infrastructure/prod/postgres-statefulset.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: roimsg
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: roimsg
spec:
  serviceName: postgres-service
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          valueFrom:
            configMapKeyRef:
              name: roimsg-config
              key: DB_NAME
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: roimsg-secrets
              key: DB_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: roimsg-secrets
              key: DB_PASSWORD
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi
```

### 3.5. 모니터링 설정

#### 3.5.1. Prometheus & Grafana

```bash
# Helm 설치
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Prometheus 설치
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-namespace

# Grafana 접속
kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80
```

### 3.6. 로그 관리

#### 3.6.1. ELK Stack (Elasticsearch, Logstash, Kibana)

```bash
# Elasticsearch 설치
helm repo add elastic https://helm.elastic.co
helm install elasticsearch elastic/elasticsearch -n logging --create-namespace

# Kibana 설치
helm install kibana elastic/kibana -n logging

# Filebeat 설치
helm install filebeat elastic/filebeat -n logging
```

### 3.7. 백업 전략

```bash
# PostgreSQL 백업 스크립트
#!/bin/bash
BACKUP_DIR="/backup/postgres"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/roimsg_prod_$TIMESTAMP.sql"

# 백업 실행
kubectl exec -n roimsg postgres-0 -- pg_dump -U roit_prod ROIMSG_PROD > $BACKUP_FILE

# 압축
gzip $BACKUP_FILE

# 30일 이전 백업 삭제
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

# S3 업로드
aws s3 cp $BACKUP_FILE.gz s3://roimsg-backups/postgres/
```

---

## 4. 환경별 설정 비교표

| 항목 | 로컬 개발 | 테스트 서버 | 운영 서버 |
|------|----------|-----------|----------|
| **OS** | Windows 10/11 | Ubuntu 22.04 | Ubuntu 22.04 |
| **배포 방식** | 직접 실행 | Docker Compose | Kubernetes |
| **데이터베이스** | PostgreSQL 15 (로컬) | PostgreSQL 15 (Docker) | PostgreSQL 15 (StatefulSet) |
| **Redis** | Redis 7 (로컬) | Redis 7 (Docker) | Redis 7 (StatefulSet) |
| **웹 서버** | Vite Dev Server | Nginx | Nginx Ingress |
| **도메인** | localhost:3000 | test.roimsg.com | roimsg.com |
| **HTTPS** | 없음 | Let's Encrypt | Let's Encrypt / CloudFlare |
| **모니터링** | 없음 | 기본 로깅 | Prometheus + Grafana |
| **로그 관리** | 파일 로그 | 파일 로그 | ELK Stack |
| **백업** | 수동 | 일일 자동 백업 | 시간별 + 일일 백업 |
| **스케일링** | 단일 인스턴스 | 2-3 인스턴스 | Auto Scaling (5-20) |
| **Google OAuth** | 개발용 계정 | 테스트용 계정 | 운영용 계정 |
| **JWT 만료** | 24시간 | 12시간 | 1시간 |
| **로그 레벨** | DEBUG | INFO | WARN |
| **보안 강화** | 기본 | 중간 | 최고 (WAF, DDoS) |

---

## 5. 환경 전환 체크리스트

### 5.1. 로컬 → 테스트

- [ ] `.env` 파일 테스트 환경 설정으로 변경
- [ ] Google OAuth 리디렉션 URI 변경
- [ ] 데이터베이스 접속 정보 변경
- [ ] Docker 이미지 빌드 및 푸시
- [ ] Docker Compose로 서비스 배포
- [ ] Nginx 설정 및 SSL 인증서 설정
- [ ] 테스트 도메인 DNS 설정
- [ ] 로그 확인 및 모니터링 설정

### 5.2. 테스트 → 운영

- [ ] 운영 환경 Secret 생성
- [ ] ConfigMap 운영 환경 설정으로 변경
- [ ] 데이터베이스 마이그레이션 실행
- [ ] Kubernetes 매니페스트 배포
- [ ] Ingress 설정 및 SSL 인증서 설정
- [ ] 운영 도메인 DNS 설정
- [ ] 모니터링 대시보드 설정 (Grafana)
- [ ] 로그 수집 설정 (ELK)
- [ ] 백업 스크립트 설정 및 테스트
- [ ] 부하 테스트 수행
- [ ] 보안 스캔 수행
- [ ] 장애 대응 계획 수립

---

## 6. 문제 해결 (Troubleshooting)

### 6.1. 데이터베이스 연결 실패

```bash
# PostgreSQL 상태 확인
sudo systemctl status postgresql

# 연결 테스트
psql -U roit -d ROIMSG -h localhost -p 5432

# 로그 확인
sudo tail -f /var/log/postgresql/postgresql-15-main.log
```

### 6.2. Redis 연결 실패

```bash
# Redis 상태 확인
redis-cli ping

# Redis 로그 확인
tail -f /var/log/redis/redis-server.log
```

### 6.3. Google OAuth 인증 실패

1. Google Cloud Console에서 OAuth 클라이언트 ID 확인
2. 리디렉션 URI가 정확히 설정되어 있는지 확인
3. 클라이언트 ID와 Secret이 환경변수에 올바르게 설정되어 있는지 확인

---

**작성자:** ROIMSG Development Team  
**최종 수정일:** 2025-10-14  
**버전:** 1.0.0

