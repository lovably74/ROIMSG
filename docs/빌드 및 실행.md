# ROIMSG 빌드 및 실행 가이드

## 목차
1. [사전 준비사항](#1-사전-준비사항)
2. [프론트엔드 빌드 및 실행](#2-프론트엔드-빌드-및-실행)
3. [백엔드 서비스별 빌드 및 실행](#3-백엔드-서비스별-빌드-및-실행)
4. [전체 시스템 실행](#4-전체-시스템-실행)
5. [Docker를 사용한 빌드 및 실행](#5-docker를-사용한-빌드-및-실행)
6. [프로덕션 빌드 및 배포](#6-프로덕션-빌드-및-배포)
7. [문제 해결](#7-문제-해결)

---

## 1. 사전 준비사항

### 1.1. 필수 설치 프로그램

다음 프로그램들이 설치되어 있어야 합니다:

- **Node.js** 18.0.0 이상
- **Java Development Kit (JDK)** 21 이상
- **Apache Maven** 3.9.0 이상
- **PostgreSQL** 15 이상
- **Redis** 7.0 이상
- **Git**

설치 확인:
```bash
node --version    # v18.0.0 이상
java --version    # openjdk 21 이상
mvn --version     # Apache Maven 3.9.0 이상
psql --version    # psql (PostgreSQL) 15 이상
redis-cli --version  # redis-cli 7.0 이상
git --version
```

### 1.2. 데이터베이스 준비

PostgreSQL 데이터베이스를 생성하고 초기화합니다:

```sql
-- PostgreSQL 접속
psql -U postgres

-- 사용자 생성
CREATE USER roit WITH PASSWORD 'fhdlxpzm1*';

-- 데이터베이스 생성
CREATE DATABASE ROIMSG OWNER roit;

-- 권한 부여
GRANT ALL PRIVILEGES ON DATABASE ROIMSG TO roit;
```

스키마 초기화:
```bash
cd scripts
npm install
node setup-database.js

# 또는 SQL 파일 직접 실행
psql -U roit -d ROIMSG -f sql/01-create-tables.sql
psql -U roit -d ROIMSG -f sql/02-create-indexes.sql
psql -U roit -d ROIMSG -f sql/03-insert-sample-data.sql
```

### 1.3. Redis 실행

```bash
# Redis 서버 시작
redis-server

# Redis 연결 확인
redis-cli ping
# 응답: PONG
```

### 1.4. 환경변수 설정

프로젝트 루트에 `.env` 파일을 생성하거나 환경변수를 설정합니다:

```bash
# Windows PowerShell
$env:GOOGLE_CLIENT_ID="386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com"
$env:GOOGLE_CLIENT_SECRET="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"
$env:DB_HOST="localhost"
$env:DB_PORT="5432"
$env:DB_NAME="ROIMSG"
$env:DB_USER="roit"
$env:DB_PASSWORD="fhdlxpzm1*"
```

---

## 2. 프론트엔드 빌드 및 실행

### 2.1. 웹 애플리케이션 (Vue.js)

#### 개발 모드 실행

```bash
# 프론트엔드 디렉토리로 이동
cd frontend/web-app

# 의존성 설치 (최초 1회)
npm install

# 환경변수 설정 (PowerShell)
$env:VITE_API_BASE_URL="http://localhost:8080"
$env:VITE_GOOGLE_CLIENT_ID="386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com"
$env:VITE_GOOGLE_REDIRECT_URI="http://localhost:3000/auth/callback"
$env:VITE_GOOGLE_AUTH_URI="https://accounts.google.com/o/oauth2/v2/auth"
$env:VITE_WS_URL="ws://localhost:3001"
$env:VITE_DEFAULT_TENANT_ID="550e8400-e29b-41d4-a716-446655440000"

# 개발 서버 실행
npm run dev
```

**접속 URL:** http://localhost:3000

#### 프로덕션 빌드

```bash
cd frontend/web-app

# 빌드
npm run build

# 빌드 결과물 확인
ls dist/

# 빌드 미리보기
npm run preview
```

#### 테스트 실행

```bash
cd frontend/web-app

# 단위 테스트
npm run test

# 테스트 커버리지
npm run test:coverage

# E2E 테스트 (선택사항)
npm run test:e2e
```

---

## 3. 백엔드 서비스별 빌드 및 실행

### 3.1. Common Starter (공통 라이브러리)

공통 라이브러리는 다른 서비스에서 의존성으로 사용됩니다. 먼저 빌드하여 로컬 Maven 저장소에 설치합니다.

```bash
cd backend/common-starter

# 빌드 및 로컬 설치
mvn clean install

# 또는 테스트 스킵
mvn clean install -DskipTests
```

### 3.2. API Gateway

#### 빌드

```bash
cd backend/api-gateway

# 빌드
mvn clean package

# 테스트 스킵 빌드
mvn clean package -DskipTests

# 빌드 결과물 확인
ls target/api-gateway-1.0.0.jar
```

#### 실행

```bash
cd backend/api-gateway

# 환경변수 설정 후 실행
$env:GOOGLE_CLIENT_ID="386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com"
$env:GOOGLE_CLIENT_SECRET="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"

# Spring Boot 실행
mvn spring-boot:run

# 또는 JAR 파일 직접 실행
java -jar target/api-gateway-1.0.0.jar
```

**포트:** 8080  
**Health Check:** http://localhost:8080/actuator/health

### 3.3. Auth Service

#### 빌드

```bash
cd backend/auth-service

# 빌드
mvn clean package -DskipTests

# 빌드 결과 확인
ls target/auth-service-1.0.0.jar
```

#### 실행

```bash
cd backend/auth-service

# 환경변수 설정
$env:GOOGLE_CLIENT_ID="386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com"
$env:GOOGLE_CLIENT_SECRET="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"
$env:GOOGLE_REDIRECT_URI="http://localhost:3000/auth/callback"

# 실행
mvn spring-boot:run
```

**포트:** 8081  
**Health Check:** http://localhost:8081/actuator/health  
**Swagger UI:** http://localhost:8081/swagger-ui.html

### 3.4. User Service

#### 빌드

```bash
cd backend/user-service

# 빌드
mvn clean package -DskipTests
```

#### 실행

```bash
cd backend/user-service

# 실행
mvn spring-boot:run
```

**포트:** 8082  
**Health Check:** http://localhost:8082/actuator/health

### 3.5. Message Service

#### 빌드

```bash
cd backend/message-service

# 빌드
mvn clean package -DskipTests
```

#### 실행

```bash
cd backend/message-service

# 실행
mvn spring-boot:run
```

**포트:** 8083  
**WebSocket:** ws://localhost:3001  
**Health Check:** http://localhost:8083/actuator/health

### 3.6. Board Service

#### 빌드

```bash
cd backend/board-service

# 빌드
mvn clean package -DskipTests
```

#### 실행

```bash
cd backend/board-service

# 실행
mvn spring-boot:run
```

**포트:** 8084  
**Health Check:** http://localhost:8084/actuator/health

### 3.7. File Service

#### 빌드

```bash
cd backend/file-service

# 빌드
mvn clean package -DskipTests
```

#### 실행

```bash
cd backend/file-service

# 파일 업로드 디렉토리 생성
mkdir -p uploads

# 실행
mvn spring-boot:run
```

**포트:** 8085  
**Health Check:** http://localhost:8085/actuator/health

### 3.8. Dashboard Service

#### 빌드

```bash
cd backend/dashboard-service

# 빌드
mvn clean package -DskipTests
```

#### 실행

```bash
cd backend/dashboard-service

# 실행
mvn spring-boot:run
```

**포트:** 8086  
**Health Check:** http://localhost:8086/actuator/health

---

## 4. 전체 시스템 실행

### 4.1. PowerShell 스크립트를 사용한 실행 (Windows)

프로젝트 루트에 제공된 스크립트를 사용하여 전체 시스템을 실행할 수 있습니다.

#### 백엔드 서비스 전체 실행

```powershell
# 프로젝트 루트에서 실행
.\start-backend-services.ps1
```

이 스크립트는 다음 서비스들을 순차적으로 새 PowerShell 창에서 실행합니다:
1. API Gateway (8080)
2. Auth Service (8081)
3. User Service (8082)
4. Message Service (8083)
5. Board Service (8084)
6. File Service (8085)
7. Dashboard Service (8086)

#### 프론트엔드 실행

```powershell
# 프론트엔드 디렉토리로 이동
cd frontend/web-app

# 환경변수 설정 및 실행
$env:VITE_API_BASE_URL="http://localhost:8080"
$env:VITE_GOOGLE_CLIENT_ID="386472545089-nms9v0b856h10q9dp380gn4t9oukbtfg.apps.googleusercontent.com"
$env:VITE_GOOGLE_REDIRECT_URI="http://localhost:3000/auth/callback"
$env:VITE_GOOGLE_AUTH_URI="https://accounts.google.com/o/oauth2/v2/auth"
$env:VITE_WS_URL="ws://localhost:3001"
$env:VITE_DEFAULT_TENANT_ID="550e8400-e29b-41d4-a716-446655440000"

npm run dev
```

### 4.2. 수동 실행 순서

각 서비스를 개별 터미널 창에서 실행합니다:

**1단계: 인프라 서비스 확인**
```bash
# PostgreSQL 실행 확인
psql -U roit -d ROIMSG -c "SELECT 1"

# Redis 실행 확인
redis-cli ping
```

**2단계: 백엔드 서비스 실행 (각각 별도 터미널)**

```bash
# 터미널 1: API Gateway
cd backend/api-gateway && mvn spring-boot:run

# 터미널 2: Auth Service
cd backend/auth-service && mvn spring-boot:run

# 터미널 3: User Service
cd backend/user-service && mvn spring-boot:run

# 터미널 4: Message Service
cd backend/message-service && mvn spring-boot:run

# 터미널 5: Board Service
cd backend/board-service && mvn spring-boot:run

# 터미널 6: File Service
cd backend/file-service && mvn spring-boot:run

# 터미널 7: Dashboard Service
cd backend/dashboard-service && mvn spring-boot:run
```

**3단계: 프론트엔드 실행**
```bash
# 터미널 8: Frontend
cd frontend/web-app
npm run dev
```

### 4.3. 서비스 상태 확인

모든 서비스가 실행되면 다음 명령어로 상태를 확인할 수 있습니다:

```powershell
# PowerShell에서 실행
$ports = 3000, 8080, 8081, 8082, 8083, 8084, 8085, 8086

foreach ($port in $ports) {
    $result = Test-NetConnection -ComputerName localhost -Port $port -WarningAction SilentlyContinue
    if ($result.TcpTestSucceeded) {
        Write-Host "✓ Port $port is open" -ForegroundColor Green
    } else {
        Write-Host "✗ Port $port is closed" -ForegroundColor Red
    }
}
```

### 4.4. 접속 URL 확인

서비스가 정상적으로 실행되면 다음 URL로 접속할 수 있습니다:

| 서비스 | URL | 설명 |
|--------|-----|------|
| 프론트엔드 | http://localhost:3000 | 웹 애플리케이션 |
| API Gateway | http://localhost:8080 | API 게이트웨이 |
| Auth Service | http://localhost:8081 | 인증 서비스 |
| Swagger UI (Auth) | http://localhost:8081/swagger-ui.html | API 문서 |
| Actuator (Auth) | http://localhost:8081/actuator/health | Health Check |

---

## 5. Docker를 사용한 빌드 및 실행

### 5.1. Docker 이미지 빌드

#### 프론트엔드

```bash
cd frontend/web-app

# Docker 이미지 빌드
docker build -t roimsg/frontend:latest .

# 이미지 확인
docker images | grep roimsg
```

#### 백엔드 서비스 (예: Auth Service)

```bash
cd backend/auth-service

# Docker 이미지 빌드
docker build -t roimsg/auth-service:latest .
```

### 5.2. Docker Compose를 사용한 실행

#### 개발 환경

```bash
# 프로젝트 루트에서 실행
cd infrastructure/test

# 서비스 시작
docker-compose up -d

# 로그 확인
docker-compose logs -f

# 서비스 상태 확인
docker-compose ps

# 서비스 중지
docker-compose down
```

#### docker-compose.yml 예시

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ROIMSG
      POSTGRES_USER: roit
      POSTGRES_PASSWORD: fhdlxpzm1*
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  api-gateway:
    build: ../../backend/api-gateway
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  auth-service:
    build: ../../backend/auth-service
    ports:
      - "8081:8081"
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    depends_on:
      - postgres
      - redis

  frontend:
    build: ../../frontend/web-app
    ports:
      - "3000:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8080
      - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
    depends_on:
      - api-gateway

volumes:
  postgres_data:
```

### 5.3. 특정 서비스만 실행

```bash
# Auth Service만 실행
docker-compose up -d postgres redis auth-service

# 프론트엔드만 실행
docker-compose up -d frontend
```

---

## 6. 프로덕션 빌드 및 배포

### 6.1. 프론트엔드 프로덕션 빌드

```bash
cd frontend/web-app

# 프로덕션 환경변수 설정
export NODE_ENV=production
export VITE_API_BASE_URL=https://api.roimsg.com

# 빌드
npm run build

# 빌드 결과물
ls -lh dist/

# 빌드 크기 분석
npm run build -- --report
```

### 6.2. 백엔드 프로덕션 빌드

```bash
# 모든 서비스 빌드
cd backend

# 빌드 스크립트 실행
for service in api-gateway auth-service user-service message-service board-service file-service dashboard-service
do
  echo "Building $service..."
  cd $service
  mvn clean package -DskipTests -Pprod
  cd ..
done
```

### 6.3. Docker 프로덕션 이미지

```bash
# 프로덕션 이미지 빌드
docker build -t roimsg/frontend:1.0.0 -f Dockerfile.prod ./frontend/web-app

# Docker Registry에 푸시
docker tag roimsg/frontend:1.0.0 registry.example.com/roimsg/frontend:1.0.0
docker push registry.example.com/roimsg/frontend:1.0.0
```

### 6.4. Kubernetes 배포

```bash
# 네임스페이스 생성
kubectl create namespace roimsg

# ConfigMap 및 Secret 생성
kubectl apply -f infrastructure/prod/configmap.yaml
kubectl apply -f infrastructure/prod/secrets.yaml

# 서비스 배포
kubectl apply -f infrastructure/prod/

# 배포 상태 확인
kubectl get pods -n roimsg
kubectl get services -n roimsg

# 로그 확인
kubectl logs -f deployment/auth-service -n roimsg

# 특정 Pod 접속
kubectl exec -it auth-service-xxx -n roimsg -- /bin/sh
```

---

## 7. 문제 해결

### 7.1. 포트 충돌

**문제:** 포트가 이미 사용 중입니다.

**해결:**
```powershell
# Windows에서 포트 사용 프로세스 확인
netstat -ano | findstr :8080

# 프로세스 종료
taskkill /PID [PID번호] /F
```

### 7.2. 빌드 실패

**문제:** Maven 빌드 실패

**해결:**
```bash
# Maven 캐시 정리
mvn clean

# 의존성 강제 업데이트
mvn clean install -U

# 오프라인 모드 비활성화
mvn clean install -Dmaven.repo.local=$HOME/.m2/repository
```

### 7.3. 데이터베이스 연결 실패

**문제:** PostgreSQL 연결 실패

**해결:**
```bash
# PostgreSQL 상태 확인
sudo systemctl status postgresql  # Linux
Get-Service postgresql*          # Windows

# PostgreSQL 재시작
sudo systemctl restart postgresql  # Linux
Restart-Service postgresql*       # Windows

# 연결 테스트
psql -U roit -d ROIMSG -h localhost -p 5432
```

### 7.4. Redis 연결 실패

**문제:** Redis 연결 실패

**해결:**
```bash
# Redis 상태 확인
redis-cli ping

# Redis 재시작
sudo systemctl restart redis  # Linux
redis-server                 # Windows

# Redis 로그 확인
tail -f /var/log/redis/redis-server.log
```

### 7.5. Google OAuth 오류

**문제:** Google OAuth 인증 실패

**해결 방법:**
1. Google Cloud Console에서 OAuth 클라이언트 ID 확인
2. Redirect URI가 정확히 설정되어 있는지 확인: `http://localhost:3000/auth/callback`
3. 클라이언트 ID와 Secret이 환경변수에 올바르게 설정되어 있는지 확인
4. Google OAuth Consent Screen이 올바르게 설정되어 있는지 확인

### 7.6. 프론트엔드 빌드 오류

**문제:** npm install 또는 빌드 실패

**해결:**
```bash
# Node modules 삭제 후 재설치
rm -rf node_modules package-lock.json
npm install

# 캐시 정리
npm cache clean --force

# Node 버전 확인
node --version  # v18.0.0 이상 필요
```

### 7.7. 메모리 부족

**문제:** 빌드 시 메모리 부족 오류

**해결:**
```bash
# Maven 힙 메모리 증가
export MAVEN_OPTS="-Xmx2048m -XX:MaxPermSize=512m"

# Node.js 메모리 증가
export NODE_OPTIONS="--max-old-space-size=4096"
```

---

## 8. 빌드 및 실행 체크리스트

### 8.1. 최초 실행 체크리스트

- [ ] JDK 21 설치 확인
- [ ] Node.js 18+ 설치 확인
- [ ] Maven 3.9+ 설치 확인
- [ ] PostgreSQL 설치 및 데이터베이스 생성
- [ ] Redis 설치 및 실행
- [ ] Google OAuth 클라이언트 ID 및 Secret 발급
- [ ] 환경변수 설정
- [ ] Common Starter 빌드
- [ ] 데이터베이스 스키마 초기화
- [ ] 백엔드 서비스 실행
- [ ] 프론트엔드 실행
- [ ] 브라우저에서 접속 확인

### 8.2. 일반 개발 실행 체크리스트

- [ ] PostgreSQL 실행 중
- [ ] Redis 실행 중
- [ ] 환경변수 설정
- [ ] 백엔드 서비스 실행
- [ ] 프론트엔드 실행
- [ ] Health Check 확인

### 8.3. 프로덕션 배포 체크리스트

- [ ] 프로덕션 환경변수 설정
- [ ] 데이터베이스 백업
- [ ] 프론트엔드 프로덕션 빌드
- [ ] 백엔드 서비스 프로덕션 빌드
- [ ] Docker 이미지 빌드 및 푸시
- [ ] Kubernetes 매니페스트 적용
- [ ] 서비스 상태 확인
- [ ] Health Check 확인
- [ ] 모니터링 대시보드 확인
- [ ] 로그 확인

---

**작성자:** ROIMSG Development Team  
**최종 수정일:** 2025-10-14  
**버전:** 1.0.0

