# ROIMSG 아키텍처 구성

## 목차
1. [아키텍처 개요](#1-아키텍처-개요)
2. [시스템 아키텍처](#2-시스템-아키텍처)
3. [마이크로서비스 아키텍처 (MSA)](#3-마이크로서비스-아키텍처-msa)
4. [데이터 아키텍처](#4-데이터-아키텍처)
5. [보안 아키텍처](#5-보안-아키텍처)
6. [통신 아키텍처](#6-통신-아키텍처)
7. [배포 아키텍처](#7-배포-아키텍처)
8. [확장성 및 성능 아키텍처](#8-확장성-및-성능-아키텍처)

---

## 1. 아키텍처 개요

### 1.1. 아키텍처 원칙

ROIMSG는 다음 아키텍처 원칙을 따릅니다:

1. **기능 단위 MSA (Microservices Architecture)**
   - 각 기능별로 독립적인 서비스 구성
   - 서비스 간 느슨한 결합 (Loose Coupling)
   - 서비스별 독립적인 배포 및 확장

2. **멀티테넌시 (Multi-Tenancy)**
   - 단일 데이터베이스에서 테넌트별 데이터 논리적 분리
   - 테넌트 ID 기반 데이터 격리
   - 테넌트별 보안 및 접근 제어

3. **확장성 (Scalability)**
   - 수평적 확장 (Horizontal Scaling)
   - 로드 밸런싱
   - 캐싱 전략

4. **보안 우선 (Security First)**
   - KISA 보안 가이드라인 준수
   - 제로 트러스트 보안 모델
   - 다층 보안 (Defense in Depth)

5. **관찰 가능성 (Observability)**
   - 로깅
   - 모니터링
   - 추적 (Tracing)

### 1.2. 아키텍처 스타일

- **프론트엔드:** SPA (Single Page Application)
- **백엔드:** 기능 단위 MSA
- **데이터:** 멀티테넌트 단일 데이터베이스
- **통신:** REST API + WebSocket
- **배포:** 컨테이너 기반 (Docker/Kubernetes)

---

## 2. 시스템 아키텍처

### 2.1. 계층 구조 (Layered Architecture)

```
┌────────────────────────────────────────────────────────────────┐
│                     Presentation Layer                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  Web Browser │  │  Mobile Web  │  │  Mobile App  │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS / WSS
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                     Gateway Layer                              │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  API Gateway (Spring Cloud Gateway)                      │ │
│  │  - Routing                                                │ │
│  │  - Authentication & Authorization                         │ │
│  │  - Rate Limiting                                          │ │
│  │  - Circuit Breaker                                        │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌────────────────────────────────────────────────────────────────┐
│                     Service Layer (MSA)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Auth Service │  │ User Service │  │  Message     │        │
│  │              │  │              │  │  Service     │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Board Service│  │ File Service │  │  Dashboard   │        │
│  │              │  │              │  │  Service     │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        │                                           │
        ▼                                           ▼
┌────────────────────────────────────┐  ┌────────────────────────┐
│       Data Layer                   │  │   Cache Layer          │
│  ┌──────────────────────────────┐  │  │  ┌──────────────────┐ │
│  │  PostgreSQL                  │  │  │  │  Redis           │ │
│  │  - Multi-Tenant Database     │  │  │  │  - Session Store │ │
│  │  - ACID Transactions         │  │  │  │  - Cache         │ │
│  └──────────────────────────────┘  │  │  │  - Pub/Sub       │ │
│                                     │  │  └──────────────────┘ │
└────────────────────────────────────┘  └────────────────────────┘
```

### 2.2. 서비스 간 통신

```
┌─────────────────────────────────────────────────────────────┐
│                       Client                                 │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            │ REST API / WebSocket
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway                               │
└───────────────────────────┬─────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Service A   │───▶│  Service B   │───▶│  Service C   │
│              │    │              │    │              │
│  REST API    │    │  REST API    │    │  REST API    │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │
       └───────────────────┴───────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │   PostgreSQL    │
                  │   Redis         │
                  └─────────────────┘
```

**통신 방식:**
- **동기 통신:** REST API (HTTP/HTTPS)
- **비동기 통신:** WebSocket, Redis Pub/Sub
- **서비스 디스커버리:** Spring Cloud Gateway (Static Configuration)

---

## 3. 마이크로서비스 아키텍처 (MSA)

### 3.1. MSA 구성 원칙

1. **단일 책임 원칙 (Single Responsibility)**
   - 각 서비스는 하나의 비즈니스 기능만 담당
   - 명확한 서비스 경계

2. **독립적 배포**
   - 서비스별 독립적인 빌드 및 배포
   - 다른 서비스에 영향 없이 업데이트 가능

3. **데이터베이스 공유 (Multi-Tenant Single DB)**
   - 멀티테넌시를 위한 단일 데이터베이스 사용
   - 테넌트 ID로 데이터 격리
   - 트랜잭션 관리 용이

4. **API 우선 설계**
   - RESTful API 설계
   - OpenAPI (Swagger) 문서화
   - 버전 관리

### 3.2. 서비스 분해 전략

```
비즈니스 도메인 기반 분해:

┌─────────────────────────────────────────────────────────────┐
│                       ROIMSG System                          │
└─────────────────────────────────────────────────────────────┘
           │
           ├─ 인증/권한 (Auth)
           │  └─ Auth Service
           │
           ├─ 사용자 관리 (User Management)
           │  └─ User Service
           │
           ├─ 메시징 (Messaging)
           │  └─ Message Service
           │     ├─ 1:1 Chat
           │     ├─ Group Chat
           │     └─ Direct Message
           │
           ├─ 게시판 (Board)
           │  └─ Board Service
           │     ├─ Post Management
           │     ├─ Comment Management
           │     └─ Tag Management
           │
           ├─ 파일 관리 (File Management)
           │  └─ File Service
           │     ├─ Upload/Download
           │     ├─ Thumbnail Generation
           │     └─ File Repository
           │
           └─ 대시보드 (Dashboard)
              └─ Dashboard Service
                 ├─ Widget Management
                 └─ Data Aggregation
```

### 3.3. 공통 라이브러리 (Common Starter)

```
common-starter/
├── exception/              # 공통 예외 처리
│   ├── GlobalExceptionHandler
│   └── CustomException
├── filter/                 # 공통 필터
│   ├── TenantContextFilter
│   └── LoggingFilter
├── dto/                    # 공통 DTO
│   ├── ApiResponse
│   └── ErrorResponse
├── util/                   # 유틸리티
│   ├── JwtUtil
│   └── EncryptionUtil
└── config/                 # 공통 설정
    ├── SecurityConfig
    └── WebConfig
```

**사용 방식:**
```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.roimsg</groupId>
    <artifactId>common-starter</artifactId>
    <version>1.0.0-SNAPSHOT</version>
</dependency>
```

---

## 4. 데이터 아키텍처

### 4.1. 멀티테넌시 데이터 모델

**전략: 테이블 내 테넌트 ID 컬럼 방식**

```sql
-- 모든 주요 테이블에 tenant_id 컬럼 추가
CREATE TABLE users (
    id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    email VARCHAR(255) NOT NULL,
    name VARCHAR(255),
    ...
    CONSTRAINT uk_tenant_email UNIQUE (tenant_id, email)
);

-- 인덱스 생성
CREATE INDEX idx_users_tenant_id ON users(tenant_id);
```

**장점:**
- 구현이 간단
- 테넌트 간 데이터 비교 및 집계 용이
- 데이터베이스 리소스 효율적

**보안 조치:**
- 모든 쿼리에 tenant_id 조건 자동 추가 (JPA Filter)
- 테넌트 간 데이터 접근 방지
- 감사 로그 (Audit Log)

### 4.2. 데이터베이스 스키마

#### 4.2.1. ER 다이어그램

```
┌────────────┐         ┌────────────┐         ┌────────────┐
│  tenants   │────┐    │   users    │────┐    │ chat_rooms │
└────────────┘    │    └────────────┘    │    └────────────┘
                  │                      │
                  │    ┌────────────┐    │    ┌────────────┐
                  └───▶│  messages  │◀───┘    │   boards   │
                       └────────────┘         └────────────┘
                              │                      │
                              │                      │
                       ┌────────────┐         ┌────────────┐
                       │   files    │         │   posts    │
                       └────────────┘         └────────────┘
                                                     │
                                              ┌────────────┐
                                              │  comments  │
                                              └────────────┘
```

#### 4.2.2. 테이블 관계

**1:N 관계:**
- tenants → users
- tenants → boards
- users → posts
- posts → comments
- chat_rooms → messages

**N:M 관계:**
- users ↔ chat_rooms (chat_room_members)
- posts ↔ tags (post_tags)

### 4.3. 데이터 액세스 패턴

```java
@Entity
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = "uuid"))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
public class User {
    @Id
    private UUID id;
    
    @Column(name = "tenant_id", nullable = false)
    private UUID tenantId;
    
    // ... other fields
}

// 사용 예시
@Service
public class UserService {
    
    @Autowired
    private EntityManager entityManager;
    
    public List<User> findAllUsers(UUID tenantId) {
        Session session = entityManager.unwrap(Session.class);
        Filter filter = session.enableFilter("tenantFilter");
        filter.setParameter("tenantId", tenantId);
        
        return userRepository.findAll();
    }
}
```

### 4.4. 캐싱 전략

**레이어별 캐싱:**

1. **브라우저 캐싱**
   - 정적 리소스 (JS, CSS, 이미지)
   - Cache-Control 헤더 사용

2. **CDN 캐싱**
   - 정적 콘텐츠
   - 미디어 파일

3. **애플리케이션 캐싱 (Redis)**
   - 사용자 세션
   - 조회 빈도가 높은 데이터
   - 게시글 목록

4. **데이터베이스 캐싱**
   - Query Result Cache
   - Second Level Cache

**캐시 무효화 전략:**
- Time-based Expiration (TTL)
- Event-based Invalidation
- Write-through Cache

---

## 5. 보안 아키텍처

### 5.1. 보안 계층

```
┌────────────────────────────────────────────────────────────┐
│  Layer 7: Application Security                             │
│  - Input Validation                                        │
│  - Output Encoding                                         │
│  - Business Logic Security                                 │
└────────────────────────────────────────────────────────────┘
                          │
┌────────────────────────────────────────────────────────────┐
│  Layer 6: Authentication & Authorization                   │
│  - JWT Token                                               │
│  - OAuth 2.0 (Google)                                      │
│  - Role-Based Access Control (RBAC)                        │
└────────────────────────────────────────────────────────────┘
                          │
┌────────────────────────────────────────────────────────────┐
│  Layer 5: API Gateway Security                             │
│  - Rate Limiting                                           │
│  - IP Whitelisting                                         │
│  - Request Validation                                      │
│  - CORS Policy                                             │
└────────────────────────────────────────────────────────────┘
                          │
┌────────────────────────────────────────────────────────────┐
│  Layer 4: Transport Security                               │
│  - TLS/SSL (HTTPS)                                         │
│  - Certificate Pinning                                     │
│  - Secure WebSocket (WSS)                                  │
└────────────────────────────────────────────────────────────┘
                          │
┌────────────────────────────────────────────────────────────┐
│  Layer 3: Network Security                                 │
│  - VPC                                                     │
│  - Security Groups                                         │
│  - Network ACL                                             │
│  - WAF (Web Application Firewall)                          │
└────────────────────────────────────────────────────────────┘
                          │
┌────────────────────────────────────────────────────────────┐
│  Layer 2: Infrastructure Security                          │
│  - OS Hardening                                            │
│  - Container Security                                      │
│  - Secrets Management                                      │
└────────────────────────────────────────────────────────────┘
                          │
┌────────────────────────────────────────────────────────────┐
│  Layer 1: Data Security                                    │
│  - Encryption at Rest (AES-256)                            │
│  - Encryption in Transit (TLS 1.3)                         │
│  - Database Access Control                                 │
│  - Audit Logging                                           │
└────────────────────────────────────────────────────────────┘
```

### 5.2. 인증 및 권한 흐름

```
┌─────────┐                                      ┌─────────────┐
│ Client  │                                      │   Google    │
└────┬────┘                                      └──────┬──────┘
     │                                                  │
     │  1. Google 로그인 요청                           │
     ├─────────────────────────────────────────────────▶
     │                                                  │
     │  2. 인증 페이지 리다이렉트                        │
     ◀─────────────────────────────────────────────────┤
     │                                                  │
     │  3. 사용자 인증 및 동의                           │
     ├─────────────────────────────────────────────────▶
     │                                                  │
     │  4. Authorization Code 반환                      │
     ◀─────────────────────────────────────────────────┤
     │                                                  │
┌────┴────┐                  ┌──────────────┐          │
│ Client  │                  │ Auth Service │          │
└────┬────┘                  └──────┬───────┘          │
     │                              │                  │
     │  5. Code로 로그인 요청        │                  │
     ├─────────────────────────────▶│                  │
     │                              │                  │
     │                              │  6. Code → Token │
     │                              ├─────────────────▶│
     │                              │                  │
     │                              │  7. Access Token │
     │                              ◀─────────────────┤
     │                              │                  │
     │                              │  8. 사용자 정보   │
     │                              ├─────────────────▶│
     │                              │                  │
     │                              │  9. User Info    │
     │                              ◀─────────────────┤
     │                              │                  │
     │                              │  10. JWT 생성     │
     │                              │                  │
     │  11. JWT Token 반환          │                  │
     ◀─────────────────────────────┤                  │
     │                              │                  │
     │  12. API 요청 (JWT Token)    │                  │
     ├─────────────────────────────▶│                  │
     │                              │  13. JWT 검증     │
     │                              │                  │
     │  14. 응답                     │                  │
     ◀─────────────────────────────┤                  │
```

### 5.3. JWT 토큰 구조

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-uuid",
    "tenant_id": "tenant-uuid",
    "email": "user@example.com",
    "name": "User Name",
    "roles": ["USER"],
    "token_type": "access",
    "iat": 1697123456,
    "exp": 1697209856
  },
  "signature": "..."
}
```

**토큰 종류:**
- **Access Token:** 1시간 유효, API 접근용
- **Refresh Token:** 7일 유효, Access Token 재발급용
- **Signup Token:** 10분 유효, 회원가입 전용

---

## 6. 통신 아키텍처

### 6.1. REST API 설계

**API 버전 관리:**
```
/api/v1/users
/api/v1/messages
/api/v2/boards  (새 버전)
```

**HTTP 메서드:**
- `GET`: 조회
- `POST`: 생성
- `PUT`: 전체 수정
- `PATCH`: 부분 수정
- `DELETE`: 삭제

**응답 구조:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "Example"
  },
  "meta": {
    "timestamp": "2025-10-14T12:00:00Z",
    "version": "1.0.0"
  }
}
```

**에러 응답:**
```json
{
  "success": false,
  "error": {
    "code": "AUTH_001",
    "message": "인증에 실패했습니다.",
    "details": "JWT 토큰이 만료되었습니다."
  }
}
```

### 6.2. WebSocket 통신

```
Client                          Message Service
  │                                    │
  │  1. WebSocket 연결 요청 (WSS)      │
  ├───────────────────────────────────▶│
  │                                    │
  │  2. JWT 검증                       │
  │                                    │
  │  3. 연결 확립                       │
  ◀───────────────────────────────────┤
  │                                    │
  │  4. 채팅방 구독                     │
  ├───────────────────────────────────▶│
  │     /topic/room/{roomId}           │
  │                                    │
  │  5. 메시지 전송                     │
  ├───────────────────────────────────▶│
  │     /app/chat                      │
  │                                    │
  │  6. 메시지 브로드캐스트             │
  ◀───────────────────────────────────┤
  │     /topic/room/{roomId}           │
```

### 6.3. 이벤트 기반 통신 (Redis Pub/Sub)

```
Service A                Redis              Service B
    │                      │                    │
    │  1. 이벤트 발행       │                    │
    ├─────────────────────▶│                    │
    │     PUBLISH          │                    │
    │     channel:message  │                    │
    │                      │                    │
    │                      │  2. 이벤트 전달    │
    │                      ├───────────────────▶│
    │                      │     SUBSCRIBE      │
    │                      │     channel:*      │
    │                      │                    │
    │                      │  3. 처리 완료      │
    │                      ◀───────────────────┤
```

---

## 7. 배포 아키텍처

### 7.1. 컨테이너 아키텍처

```
┌────────────────────────────────────────────────────────────┐
│                     Kubernetes Cluster                     │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │                   Ingress Controller                  │ │
│  │              (Nginx Ingress / Traefik)               │ │
│  └──────────────────────────────────────────────────────┘ │
│                            │                               │
│  ┌─────────────────────────┴────────────────────────────┐ │
│  │                                                       │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │ │
│  │  │   Pod 1    │  │   Pod 2    │  │   Pod 3    │    │ │
│  │  │            │  │            │  │            │    │ │
│  │  │  Frontend  │  │ API Gateway│  │Auth Service│    │ │
│  │  │  Container │  │  Container │  │  Container │    │ │
│  │  └────────────┘  └────────────┘  └────────────┘    │ │
│  │                                                       │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │ │
│  │  │   Pod 4    │  │   Pod 5    │  │   Pod 6    │    │ │
│  │  │            │  │            │  │            │    │ │
│  │  │User Service│  │ Message    │  │Board Service│   │ │
│  │  │  Container │  │  Service   │  │  Container │    │ │
│  │  └────────────┘  └────────────┘  └────────────┘    │ │
│  │                                                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                               │
│  ┌─────────────────────────┴────────────────────────────┐ │
│  │                                                       │ │
│  │  ┌────────────────┐          ┌────────────────┐     │ │
│  │  │  StatefulSet   │          │  StatefulSet   │     │ │
│  │  │                │          │                │     │ │
│  │  │   PostgreSQL   │          │     Redis      │     │ │
│  │  │                │          │                │     │ │
│  │  └────────────────┘          └────────────────┘     │ │
│  │                                                       │ │
│  └───────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

### 7.2. CI/CD 파이프라인

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Developer │────▶│  Git Repo   │────▶│   GitHub    │
│             │     │   (Commit)  │     │   Actions   │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                    ┌──────────────────────────┘
                    │
       ┌────────────┴────────────┐
       │                         │
       ▼                         ▼
┌─────────────┐           ┌─────────────┐
│  Build &    │           │    Test     │
│  Compile    │           │  - Unit     │
│             │           │  - Integ.   │
└──────┬──────┘           └──────┬──────┘
       │                         │
       └────────────┬────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │  Security Scan   │
         │  - SAST          │
         │  - Dependency    │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────┐
         │  Docker Build    │
         │  & Push to       │
         │  Registry        │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────┐
         │  Deploy to K8s   │
         │  - Dev           │
         │  - Test          │
         │  - Prod          │
         └──────────────────┘
```

---

## 8. 확장성 및 성능 아키텍처

### 8.1. 수평적 확장 (Horizontal Scaling)

```
                   ┌────────────────┐
                   │ Load Balancer  │
                   └────────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Service     │    │  Service     │    │  Service     │
│  Instance 1  │    │  Instance 2  │    │  Instance 3  │
└──────────────┘    └──────────────┘    └──────────────┘
```

**Auto Scaling 정책:**
- CPU 사용률 > 70% → Scale Out
- CPU 사용률 < 30% → Scale In
- 최소 인스턴스: 2
- 최대 인스턴스: 10

### 8.2. 캐싱 전략

```
Client Request
      │
      ▼
┌────────────┐  Cache Hit    ┌────────────┐
│   Redis    │◀─────────────│  Service   │
│   Cache    │               └────────────┘
└─────┬──────┘                      │
      │                             │ Cache Miss
      │                             ▼
      │                      ┌────────────┐
      └─────────────────────▶│ PostgreSQL │
         Cache Miss          └────────────┘
```

### 8.3. 데이터베이스 최적화

**Read Replica:**
```
┌────────────┐          ┌────────────┐
│   Master   │─────────▶│  Replica 1 │
│ PostgreSQL │  Async   │ (Read Only)│
└─────┬──────┘  Repl.   └────────────┘
      │                 ┌────────────┐
      └────────────────▶│  Replica 2 │
         Async Repl.    │ (Read Only)│
                        └────────────┘
```

**Connection Pooling:**
- HikariCP 사용
- 최소 풀 크기: 5
- 최대 풀 크기: 20
- Connection Timeout: 30초

### 8.4. 성능 모니터링

```
Application                Prometheus              Grafana
     │                          │                     │
     │  Metrics 노출             │                     │
     ├─────────────────────────▶│                     │
     │  /actuator/prometheus    │                     │
     │                          │                     │
     │                          │  데이터 수집         │
     │                          │                     │
     │                          │  시각화 요청         │
     │                          ├────────────────────▶│
     │                          │                     │
     │                          │  대시보드 표시       │
     │                          ◀────────────────────┤
```

---

**작성자:** ROIMSG Development Team  
**최종 수정일:** 2025-10-14  
**버전:** 1.0.0

