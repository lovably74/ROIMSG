# ROIMSG 시스템구성

## 목차
1. [시스템 개요](#1-시스템-개요)
2. [전체 시스템 구조](#2-전체-시스템-구조)
3. [네트워크 구성](#3-네트워크-구성)
4. [백엔드 서비스 구성](#4-백엔드-서비스-구성)
5. [프론트엔드 구성](#5-프론트엔드-구성)
6. [데이터베이스 구성](#6-데이터베이스-구성)
7. [인프라 구성](#7-인프라-구성)

---

## 1. 시스템 개요

### 1.1. 시스템 목적
ROIMSG는 멀티테넌시 기반의 메시징 및 커뮤니케이션 플랫폼으로, 다음과 같은 주요 기능을 제공합니다:
- Google OAuth 기반 사용자 인증
- 실시간 메시징 (1:1, 그룹 채팅, 쪽지)
- 게시판 및 자료실
- 사용자 정의 대시보드

### 1.2. 시스템 특징
- **멀티테넌시:** 단일 데이터베이스에서 테넌트별 데이터 논리적 분리
- **MSA 아키텍처:** 기능 단위로 독립적인 마이크로서비스 구성
- **확장성:** 수평적 확장 가능한 구조
- **보안:** KISA 보안 가이드라인 준수

---

## 2. 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자 (Browser)                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Nginx / Ingress (LB)                          │
│                    - SSL Termination                             │
│                    - Reverse Proxy                               │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┴──────────────────┐
        │                                      │
        ▼                                      ▼
┌──────────────────┐                  ┌──────────────────┐
│  Frontend (Vue)  │                  │  API Gateway     │
│  Port: 3000      │                  │  Port: 8080      │
│                  │                  │  - Routing       │
│  - Web App       │                  │  - Auth Check    │
│  - Mobile Web    │                  │  - Rate Limit    │
└──────────────────┘                  └────────┬─────────┘
                                               │
                    ┌──────────────────────────┼──────────────────┐
                    │                          │                  │
                    ▼                          ▼                  ▼
         ┌────────────────────┐    ┌────────────────────┐  ┌────────────────────┐
         │  Auth Service      │    │  User Service      │  │  Message Service   │
         │  Port: 8081        │    │  Port: 8082        │  │  Port: 8083        │
         │                    │    │                    │  │  + WebSocket       │
         │  - Google OAuth    │    │  - User CRUD       │  │  - 1:1 Chat        │
         │  - JWT Issue       │    │  - Profile Mgmt    │  │  - Group Chat      │
         │  - Token Refresh   │    │  - User Search     │  │  - Direct Message  │
         └────────────────────┘    └────────────────────┘  └────────────────────┘
                    │                          │                  │
                    └──────────────────────────┼──────────────────┘
                                               │
                    ┌──────────────────────────┼──────────────────┐
                    ▼                          ▼                  ▼
         ┌────────────────────┐    ┌────────────────────┐  ┌────────────────────┐
         │  Board Service     │    │  File Service      │  │ Dashboard Service  │
         │  Port: 8084        │    │  Port: 8085        │  │  Port: 8086        │
         │                    │    │                    │  │                    │
         │  - Post CRUD       │    │  - File Upload     │  │  - Widget Config   │
         │  - Comment         │    │  - File Download   │  │  - Data Aggregate  │
         │  - Tag System      │    │  - Thumbnail       │  │  - Real-time Data  │
         └────────────────────┘    └────────────────────┘  └────────────────────┘
                    │                          │                  │
                    └──────────────────────────┼──────────────────┘
                                               │
                    ┌──────────────────────────┴──────────────────┐
                    ▼                                             ▼
         ┌────────────────────┐                        ┌────────────────────┐
         │  PostgreSQL        │                        │  Redis             │
         │  Port: 5432        │                        │  Port: 6379        │
         │                    │                        │                    │
         │  - Main Database   │                        │  - Session Store   │
         │  - Multi-Tenancy   │                        │  - Cache           │
         │  - Transaction     │                        │  - Pub/Sub         │
         └────────────────────┘                        └────────────────────┘
```

---

## 3. 네트워크 구성

### 3.1. 포트 구성

| 서비스 | 포트 | 프로토콜 | 용도 |
|--------|------|---------|------|
| Frontend (Web) | 3000 | HTTP | Vue.js 웹 애플리케이션 |
| API Gateway | 8080 | HTTP | API 라우팅 및 인증 |
| Auth Service | 8081 | HTTP | 인증 및 토큰 관리 |
| User Service | 8082 | HTTP | 사용자 관리 |
| Message Service | 8083 | HTTP | 메시징 |
| Board Service | 8084 | HTTP | 게시판 |
| File Service | 8085 | HTTP | 파일 관리 |
| Dashboard Service | 8086 | HTTP | 대시보드 |
| WebSocket | 3001 | WS | 실시간 통신 |
| PostgreSQL | 5432 | TCP | 데이터베이스 |
| Redis | 6379 | TCP | 캐시 및 세션 |
| Prometheus | 9090 | HTTP | 메트릭 수집 |
| Grafana | 3001 | HTTP | 모니터링 대시보드 |

### 3.2. 네트워크 보안

#### 3.2.1. 방화벽 규칙 (로컬 개발 환경)
```powershell
# Windows Firewall 설정
# 개발 환경에서는 모든 포트 허용

# 프론트엔드
netsh advfirewall firewall add rule name="ROIMSG Frontend" dir=in action=allow protocol=TCP localport=3000

# API Gateway
netsh advfirewall firewall add rule name="ROIMSG API Gateway" dir=in action=allow protocol=TCP localport=8080

# 백엔드 서비스들
netsh advfirewall firewall add rule name="ROIMSG Backend" dir=in action=allow protocol=TCP localport=8081-8086
```

#### 3.2.2. 방화벽 규칙 (운영 환경)
```bash
# Ubuntu UFW 설정
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 22/tcp    # SSH (관리용)

# 내부 서비스는 외부 접근 차단
sudo ufw deny 5432/tcp   # PostgreSQL
sudo ufw deny 6379/tcp   # Redis
sudo ufw deny 8080-8086/tcp  # 백엔드 서비스들

sudo ufw enable
```

### 3.3. 도메인 및 URL 구조

#### 로컬 개발 환경
```
Frontend:     http://localhost:3000
API Gateway:  http://localhost:8080
WebSocket:    ws://localhost:3001
```

#### 테스트 환경
```
Frontend:     https://test.roimsg.com
API:          https://test.roimsg.com/api
WebSocket:    wss://test.roimsg.com/ws
```

#### 운영 환경
```
Frontend:     https://roimsg.com
API:          https://api.roimsg.com
WebSocket:    wss://ws.roimsg.com
Admin:        https://admin.roimsg.com
```

---

## 4. 백엔드 서비스 구성

### 4.1. API Gateway

**역할:**
- 모든 클라이언트 요청의 진입점
- 라우팅 및 로드 밸런싱
- 인증 및 권한 검증
- Rate Limiting
- CORS 처리

**기술 스택:**
- Spring Cloud Gateway
- Spring Security
- Redis (Rate Limiting)

**주요 엔드포인트:**
```
/auth/**         → Auth Service
/users/**        → User Service
/messages/**     → Message Service
/boards/**       → Board Service
/files/**        → File Service
/dashboard/**    → Dashboard Service
```

### 4.2. Auth Service

**역할:**
- Google OAuth 인증 처리
- JWT 토큰 발급 및 검증
- 토큰 갱신
- 사용자 세션 관리

**기술 스택:**
- Spring Boot 3
- Spring Security OAuth2
- JWT (jjwt)
- H2 Database (개발), PostgreSQL (운영)

**주요 기능:**
- Google OAuth 로그인: `POST /auth/google/login`
- Google 회원가입: `POST /auth/google/signup`
- 토큰 갱신: `POST /auth/refresh`
- 로그아웃: `POST /auth/logout`
- 현재 사용자 조회: `GET /auth/me`

### 4.3. User Service

**역할:**
- 사용자 정보 관리
- 프로필 관리
- 사용자 검색
- 테넌트 관리

**기술 스택:**
- Spring Boot 3
- Spring Data JPA
- PostgreSQL

**주요 기능:**
- 사용자 조회: `GET /users/{userId}`
- 사용자 수정: `PUT /users/{userId}`
- 사용자 삭제: `DELETE /users/{userId}`
- 사용자 검색: `GET /users/search`
- 프로필 이미지 업로드: `POST /users/{userId}/profile-image`

### 4.4. Message Service

**역할:**
- 실시간 채팅 (1:1, 그룹)
- 쪽지 시스템
- 메시지 알림
- 파일 첨부

**기술 스택:**
- Spring Boot 3
- Spring WebSocket
- STOMP
- Redis Pub/Sub
- PostgreSQL

**주요 기능:**
- 채팅방 생성: `POST /messages/rooms`
- 채팅방 목록: `GET /messages/rooms`
- 메시지 전송: `POST /messages/rooms/{roomId}/messages`
- 메시지 조회: `GET /messages/rooms/{roomId}/messages`
- 쪽지 전송: `POST /messages/direct`

### 4.5. Board Service

**역할:**
- 게시글 관리
- 댓글 및 답글
- 태그 시스템
- 좋아요/싫어요
- 검색 및 필터링

**기술 스택:**
- Spring Boot 3
- Spring Data JPA
- PostgreSQL
- Elasticsearch (검색, 선택사항)

**주요 기능:**
- 게시글 목록: `GET /boards/{boardId}/posts`
- 게시글 작성: `POST /boards/{boardId}/posts`
- 게시글 조회: `GET /boards/{boardId}/posts/{postId}`
- 게시글 수정: `PUT /boards/{boardId}/posts/{postId}`
- 댓글 작성: `POST /boards/{boardId}/posts/{postId}/comments`

### 4.6. File Service

**역할:**
- 파일 업로드/다운로드
- 썸네일 생성
- PDF 미리보기
- 파일 메타데이터 관리

**기술 스택:**
- Spring Boot 3
- MinIO / AWS S3 (파일 스토리지)
- ImageMagick (이미지 처리)
- PDFBox (PDF 처리)

**주요 기능:**
- 파일 업로드: `POST /files/upload`
- 파일 다운로드: `GET /files/{fileId}/download`
- 썸네일 조회: `GET /files/{fileId}/thumbnail`
- 파일 삭제: `DELETE /files/{fileId}`

### 4.7. Dashboard Service

**역할:**
- 위젯 구성 관리
- 실시간 데이터 집계
- 사용자별 대시보드 설정

**기술 스택:**
- Spring Boot 3
- Spring Data JPA
- Redis (캐싱)
- PostgreSQL

**주요 기능:**
- 대시보드 조회: `GET /dashboard`
- 위젯 추가: `POST /dashboard/widgets`
- 위젯 수정: `PUT /dashboard/widgets/{widgetId}`
- 위젯 삭제: `DELETE /dashboard/widgets/{widgetId}`

### 4.8. Common Starter (공통 라이브러리)

**역할:**
- 공통 유틸리티 함수
- 공통 예외 처리
- 공통 응답 포맷
- 멀티테넌시 필터
- 로깅 및 모니터링

**기술 스택:**
- Spring Boot Starter
- Aspect (AOP)
- Jackson (JSON 처리)

**제공 기능:**
- 테넌트 컨텍스트 관리
- 예외 핸들러
- 응답 래퍼
- 로깅 인터셉터

---

## 5. 프론트엔드 구성

### 5.1. 웹 애플리케이션 (Vue.js)

**구조:**
```
frontend/web-app/
├── src/
│   ├── assets/          # 정적 리소스 (이미지, 폰트)
│   ├── components/      # 재사용 컴포넌트
│   │   ├── common/      # 공통 컴포넌트
│   │   ├── layout/      # 레이아웃 컴포넌트
│   │   └── widgets/     # 위젯 컴포넌트
│   ├── layouts/         # 레이아웃 템플릿
│   │   ├── DefaultLayout.vue
│   │   ├── AuthLayout.vue
│   │   └── AdminLayout.vue
│   ├── locales/         # 다국어 리소스
│   │   ├── ko.json
│   │   └── en.json
│   ├── plugins/         # Vue 플러그인
│   │   ├── vuetify.ts
│   │   ├── i18n.ts
│   │   └── axios.ts
│   ├── router/          # 라우팅 설정
│   │   └── index.ts
│   ├── stores/          # Pinia 스토어
│   │   ├── auth.ts
│   │   ├── user.ts
│   │   ├── message.ts
│   │   └── board.ts
│   ├── styles/          # 스타일시트
│   │   ├── variables.scss
│   │   ├── common.scss
│   │   └── theme.scss
│   ├── types/           # TypeScript 타입 정의
│   │   ├── user.ts
│   │   ├── message.ts
│   │   └── board.ts
│   ├── utils/           # 유틸리티 함수
│   │   ├── api.ts
│   │   ├── auth.ts
│   │   └── format.ts
│   ├── views/           # 페이지 컴포넌트
│   │   ├── auth/
│   │   ├── dashboard/
│   │   ├── messages/
│   │   ├── boards/
│   │   └── files/
│   ├── App.vue          # 루트 컴포넌트
│   └── main.ts          # 진입점
└── package.json
```

**기술 스택:**
- Vue.js 3 (Composition API)
- TypeScript
- Vite (빌드 도구)
- Pinia (상태 관리)
- Vue Router (라우팅)
- Vuetify (UI 프레임워크)
- Axios (HTTP 클라이언트)
- Socket.io-client (WebSocket)

### 5.2. 모바일 웹 애플리케이션

**특징:**
- 반응형 디자인
- 모바일 최적화
- Progressive Web App (PWA)
- 오프라인 지원

---

## 6. 데이터베이스 구성

### 6.1. PostgreSQL

**버전:** 15.x

**주요 테이블:**

#### 6.1.1. 사용자 관련
```sql
-- 테넌트 테이블
CREATE TABLE tenants (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 사용자 테이블
CREATE TABLE users (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    google_id VARCHAR(255),
    email VARCHAR(255) NOT NULL,
    name VARCHAR(255),
    profile_image_url TEXT,
    custom_profile_image_url TEXT,
    phone_number VARCHAR(50),
    address TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, email)
);
```

#### 6.1.2. 메시지 관련
```sql
-- 채팅방 테이블
CREATE TABLE chat_rooms (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    name VARCHAR(255),
    type VARCHAR(50),  -- 'DIRECT', 'GROUP'
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 메시지 테이블
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    room_id UUID REFERENCES chat_rooms(id),
    sender_id UUID REFERENCES users(id),
    content TEXT,
    type VARCHAR(50),  -- 'TEXT', 'FILE', 'IMAGE'
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 6.1.3. 게시판 관련
```sql
-- 게시판 테이블
CREATE TABLE boards (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 게시글 테이블
CREATE TABLE posts (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    board_id UUID REFERENCES boards(id),
    author_id UUID REFERENCES users(id),
    title VARCHAR(500) NOT NULL,
    content TEXT,
    is_secret BOOLEAN DEFAULT FALSE,
    is_notice BOOLEAN DEFAULT FALSE,
    view_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2. Redis

**용도:**
- 세션 스토어
- 캐싱 (사용자 정보, 게시글 목록 등)
- Rate Limiting
- Pub/Sub (실시간 알림)

**키 네이밍 규칙:**
```
session:{sessionId}         # 세션 데이터
user:cache:{userId}         # 사용자 캐시
board:list:{boardId}        # 게시글 목록 캐시
rate_limit:{ip}:{endpoint}  # Rate Limiting
```

---

## 7. 인프라 구성

### 7.1. 로컬 개발 환경

```
Developer Machine (Windows)
├── Frontend (Vite Dev Server)
├── Backend Services (Spring Boot)
├── PostgreSQL (Local)
└── Redis (Local)
```

### 7.2. 테스트 환경 (Docker Compose)

```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  api-gateway:
    build: ./backend/api-gateway
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - redis
  
  auth-service:
    build: ./backend/auth-service
    ports:
      - "8081:8081"
    depends_on:
      - postgres
  
  frontend:
    build: ./frontend/web-app
    ports:
      - "3000:3000"
    depends_on:
      - api-gateway
```

### 7.3. 운영 환경 (Kubernetes)

**네임스페이스:**
- `roimsg-prod`: 운영 서비스
- `roimsg-monitoring`: 모니터링 도구
- `roimsg-logging`: 로깅 도구

**주요 리소스:**
- Deployments: 각 마이크로서비스
- StatefulSets: PostgreSQL, Redis
- Services: 서비스 간 통신
- Ingress: 외부 트래픽 라우팅
- ConfigMaps: 설정 관리
- Secrets: 민감 정보 관리
- PersistentVolumes: 데이터 영속성

---

## 8. 모니터링 및 로깅

### 8.1. 모니터링 스택

**Prometheus:**
- 메트릭 수집
- 알림 규칙 설정
- 서비스 헬스 체크

**Grafana:**
- 대시보드 시각화
- 실시간 모니터링
- 알림 설정

**모니터링 대상:**
- CPU, 메모리, 디스크 사용률
- 네트워크 트래픽
- HTTP 요청/응답 시간
- 에러율
- 데이터베이스 쿼리 성능
- JVM 메트릭

### 8.2. 로깅 스택

**Elasticsearch:**
- 로그 저장 및 인덱싱
- 전문 검색

**Logstash:**
- 로그 수집 및 파싱
- 로그 변환

**Kibana:**
- 로그 시각화
- 로그 검색 및 필터링

---

## 9. 보안 구성

### 9.1. 네트워크 보안
- VPC 구성
- 서브넷 분리 (Public/Private)
- Security Group 설정
- WAF (Web Application Firewall)
- DDoS 방어

### 9.2. 애플리케이션 보안
- HTTPS 강제 사용
- JWT 토큰 기반 인증
- OAuth 2.0 인증
- CORS 설정
- Rate Limiting
- SQL Injection 방지
- XSS 방지
- CSRF 방지

### 9.3. 데이터 보안
- 데이터 암호화 (AES-256)
- SSL/TLS 통신
- 정기 백업
- 접근 권한 관리

---

**작성자:** ROIMSG Development Team  
**최종 수정일:** 2025-10-14  
**버전:** 1.0.0

